---
output:
  pdf_document: default
  html_document: default
---
# Drugi zadatak

```{r}
library(readr)
require(dplyr)
```

```{r}
dataset <- read_csv("preprocessed_data.csv")
```

2. Ovisi li veličina podruma o kvartu u gradu?

U podacima postoje varijable TotalBsmtSF te Neighborhood. TotalBsmtSF predstavlja veličinu podruma za pojedinu nekretninu u kvadratnim stopama. Neighborhood predstavlja kvart kojoj nekretnina pripada. Nekretnine s veličinom podruma 0 kvadratnih stopa nećemo koristiti u analizi.

Kako bismo odgovorili na ovo istraživačko pitanje, koristit ćemo metodu ANOVA, odnosno analizirat ćemo varijance. ANOVA je metoda kojom testiramo sredine više populacija. U analizi varijance pretpostavlja se da je ukupna varijabilnost u podatcima posljedica varijabilnosti podataka unutar svake pojedine populacije i varijabilnosti između različitih grupa. Varijabilnost unutar pojedinog uzorka je rezultat slučajnosti, a ako postoje razlike u sredinama populacija, one će biti odražene u varijabilnosti među grupama. Analizom varijance htjeli bismo istražiti je li razlika između varijanci slučajna ili nam je statistički značajna.

Budući da u našem pitanju ispitujemo veličinu podruma za različite kvartove, koristit ćemo jedno-faktorski ANOVA model. U jednofaktorskom ANOVA modelu razmatra se utjecaj jednog faktora koji ima k razina.

Neka su:
$$ \begin{aligned}
  X_{11}, X_{12}, \ldots, X_{1n_1} & \sim N(\mu_1, \sigma^2) \\
  X_{21}, X_{22}, \ldots, X_{2n_2} & \sim N(\mu_2, \sigma^2) \\
  & \vdots\\
  X_{k1}, X_{k2}, \ldots, X_{kn_k} & \sim N(\mu_k, \sigma^2)
\end{aligned} $$
nezavisni uzorci iz $k$ različitih populacija (populacije se razlikuju upravo po razini faktora od interesa). Jednofaktorski ANOVA model glasi:
$$ X_{ij} = \mu_{i} + \epsilon_{ij}, $$
gdje je $\mu_{j}$ sredina svake populacije $i = 1,..,k$. Analizom varijance testiramo:
$$ \begin{aligned}
  H_0 & : \mu_1 = \mu_2 = \ldots = \mu_k \\
  H_1 & : \text{barem dvije sredine nisu iste}.
\end{aligned} $$

Jednofaktorski model možemo zapisati i kao
$$ X_{ij} = \mu + \alpha_i + \epsilon_{ij}, $$
gdje je $\mu$ srednja vrijednost svih $\mu_i$
$$ \mu = \frac{1}{k} \sum_{i=1}^k \mu_i, $$
a $\alpha_i$ nazivamo efektom $i$-tog tretmana. Ekvivalentna hipoteza je sad 
$$ \begin{aligned}
  H_0 & : \alpha_1 = \alpha_2 = \ldots = \alpha_k = 0 \\
  H_1 & : \text{barem jedna $\alpha_i$ je različita od 0.}
\end{aligned} $$

Razmatramo sljedeće mjere varijabilnosti u podatcima
$$ \begin{aligned}
SST &= \sum_{i=1}^k \sum_{j=1}^n (x_{ij} - \bar{x}_{..})^2 = \text{total sum of squares, ukupna varijabilnost} \\
SSA &= n \sum_{i=1}^k (\bar{x}_{i.} - \bar{x}_{..})^2 = \text{treatment sum of squares, varijabilnost između grupa} \\
SSE &= \sum_{i=1}^k \sum_{j=1}^n (x_{ij} - \bar{x}_{i.})^2 = \text{error sum of squares, varijabilnost unutar grupa}
\end{aligned}$$

Nadalje, pretpostavke metode ANOVA su: nezavisnost pojedinih podataka u uzorcima, normalna razdioba podataka i homogenost varijanci među populacijama.

Provjera normalnosti može se za svaku pojedinu grupu napraviti Kolmogorov-Smirnov testom ili Lillieforsovom inačicom navedenog testa. U ovom slučaju razmatrat ćemo veličinu kvarta kao nezavisnu varijablu i veličinu kvarta kao zavisnu varijablu.

Kako bi provjerili normalnost podataka za veličinu podruma, prvo moramo pripremiti i počistiti podatke. 

```{r priprema podataka za velicinu podruma}
# Graficki prikaz podataka za velicinu podruma
hist(dataset$TotalBsmtSF, breaks = 40, main="Velicine podruma nekretnina",xlab="Velicina podruma",
     ylab="Frekvencije", col="#69b3a2", border="white")
qqnorm(dataset$TotalBsmtSF, col="#69b3a2")
qqline(dataset$TotalBsmtSF)
```

Očito je kako podaci nisu normalni pa ćemo maknuti outliere. Najveći problem predstavljaju podrumi iznad 3000 kvadratnih stopa i oni čija je vrijednost 0. 

```{r ciscenje podataka za velicinu podruma}

# Micanje outliera
quartiles = quantile(dataset$TotalBsmtSF, probs=c(.25, .75), na.rm=FALSE)
IQR = IQR(dataset$TotalBsmtSF)
lower <- quartiles[1] - 1.5*IQR
upper <- quartiles[2] + 1.5*IQR 

dataset_pit2 = subset(dataset, dataset$TotalBsmtSF > lower & dataset$TotalBsmtSF < upper)

# Graficki prikaz podataka nakon micanja outliera
hist(dataset_pit2$TotalBsmtSF, breaks = 20, main="Velicine podruma nekretnina",xlab="Velicina podruma",
     ylab="Frekvencije", col="#69b3a2", border="white")
qqnorm(dataset_pit2$TotalBsmtSF, col="#69b3a2")
qqline(dataset_pit2$TotalBsmtSF)
```

Podaci za veličinu podruma sada izgledaju normalnije. Osim veličine podruma, moramo provjeriti postoje li kvartovi u kojima se nalaze nekretnine koje bi mogle utjecati na daljnju analizu zbog nedovoljne količine podataka.

```{r priprema podataka za kvartove}
unique_neighbourhoods <- sort(unique(dataset_pit2$Neighborhood))

# Broj kvartova u datasetu
length(unique_neighbourhoods)

# Prikaz nekretnina po kvartovima
dataset_pit2 %>%
  group_by(Neighborhood) %>%
  count() -> grouped_neighborhoods

barplot(grouped_neighborhoods$n, names.arg=grouped_neighborhoods$Neighborhood, col="#69b3a2", border = "white", las=3)

table(dataset_pit2$Neighborhood)
```

Grafičkim i tabličnim prikazom smo dobili broj nekretnina po kvartu. Iz daljnje analize maknut ćemo kvartove koji imaju manje od 50 nekretnina kako bi bili sigurniji u vjerodostojnosti podataka.

```{r ciscenje podataka za kvartove}
# micanje kvartova koji imaju manje od 50 nekretnina
not_normal_neighbourhoods <- c("Blmngtn", "Blueste", "BrDale", "ClearCr","IDOTRR", "MeadowV","Mitchel", "NoRidge","NPkVill","StoneBr", "SWISU","Timber", "Veenker")

dataset <- subset(dataset_pit2, !Neighborhood %in% not_normal_neighbourhoods)
length(unique(dataset_pit2$Neighborhood))
```

Nakon dodatnog čišćenja, preostaje nam 12 kvartova koji su nam važni za nastavak analize. Sada ćemo maknuti outliere za pojedini kvart.

```{r ciscenje podataka za kvartove}
dataset_pit2 <- dataset_pit2 %>% 
  group_by(Neighborhood) %>% 
  mutate(Q1 = quantile(TotalBsmtSF, .25),
         Q3 = quantile(TotalBsmtSF, .75),
         IQR = IQR(TotalBsmtSF),
         lower_bound = Q1 - 1.5*IQR,
         upper_bound = Q3 + 1.5*IQR) %>%
  filter(TotalBsmtSF > lower_bound & TotalBsmtSF < upper_bound)
```

```{r graficki prikaz preostalih kvartova}
dataset_pit2 %>%
  group_by(Neighborhood) %>%
  count() -> grouped_neighborhoods

barplot(grouped_neighborhoods$n, names.arg=grouped_neighborhoods$Neighborhood, col="#69b3a2", border = "white", las=3)
```

Možemo vidjeti kako sada više nema kvartova s manje od 50 nekretnina. 

Nakon čišćenja svih podataka, provest ćemo Lillieforseov test za sve veličine podruma i veličine podruma po kvartovima.

```{r test pretpostavki - normalnost}
require(nortest)
lillie.test(dataset_pit2$TotalBsmtSF)

lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="BrkSide"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="CollgCr"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="Crawfor"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="Edwards"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="Gilbert"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="NAmes"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="NridgHt"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="NWAmes"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="OldTown"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="Sawyer"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="SawyerW"])
lillie.test(dataset_pit2$TotalBsmtSF[dataset_pit2$Neighborhood=="Somerst"])
```

Iz rezultata Lillieforsove inačice Kolmogorov-Smirnov testa vidimo da podaci nisu normalne razdiobe jer je p-vrijednost približna 0. Ako gledamo normalnost veličine podruma unutar kvarta, vidimo da su unutar šest kvartova podaci ipak normalno distribuirani.

Što se tiče homogenosti varijanci različitih populacija, potrebno je testirati:
$$ \begin{aligned}
  H_0 & : \sigma_1^2 = \sigma_2^2 = \ldots = \sigma_k^2 \\
  H_1 & : \text{barem dvije varijance nisu iste}.
\end{aligned} $$

```{r test pretpostavki - homogenost varijanci}
# Testiranje homogenosti varijance uzoraka Bartlettovim testom
bartlett.test(dataset_pit2$TotalBsmtSF ~ dataset_pit2$Neighborhood)
```

Bartlettovim testom nezavisnosti dobili smo iznimno malu p-vrijednost što nam sugerira da postoje barem dva kvarta koja imaju različitu varijancu za veličinu podruma. U to se možemo uvjeriti i grafički.

```{r test razlike u velicini podruma}

# Graficki prikaz podataka
par(mar=c(5.1, 5.1, 4.1, 2.1), mgp=c(4,1,0))
boxplot(dataset_pit2$TotalBsmtSF ~ dataset_pit2$Neighborhood, col="#69b3a2", xlab = "Kvartovi", ylab="Povrsina podruma", las=3)
        
# Test
a = aov(dataset_pit2$TotalBsmtSF ~ dataset_pit2$Neighborhood)
summary(a)
```

Grafički prikaz sugerira da postoji jasna razlika u veličinama podruma za pojedinačni kvart, što potvrđuje i ANOVA.

Budući da je p-vrijednost približna nuli, odbacujemo nultu hipotezu u korist alternative, odnosno sa sigurnošću zaključujemo da veličina podruma ovisi o kvartu.